---
import fs from 'node:fs/promises'
import { Image } from 'astro:assets'
import type { ComponentProps } from 'astro/types'
import { getPlaiceholder } from 'plaiceholder'

type Props = { lqipSrc: string; lqipSize?: number } & ComponentProps<
  typeof Image
>

const { lqipSrc, lqipSize = 4, style, ...rest } = Astro.props

const cleanImageSrc = lqipSrc.replace('/@fs', '').split('?')[0]
const file = await fs.readFile(cleanImageSrc)

const { base64 } = await getPlaiceholder(file, { size: lqipSize })

const lqipBackgroundStyle = `
  color: transparent;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-image: url('data:image/svg+xml;charset=utf-8,\
    <svg xmlns="http://www.w3.org/2000/svg">\
      <filter id="b" color-interpolation-filters="sRGB">\
        <feGaussianBlur stdDeviation="20"/>\
        <feComponentTransfer>\
            <feFuncA type="discrete" tableValues="1 1"/>\
        </feComponentTransfer>\
      </filter>\
      <g filter="url(%23b)">\
        <image width="100%" height="100%" href="${base64}"/>\
      </g>\
    </svg>\
  ');
`
---

<Image style={[style, lqipBackgroundStyle].join(' ')} {...rest} />
